## sot-cqp æ–‡æ¡£ 

 [![Build status](?svg=true)]()

sot-cqp å…è®¸ä½ é€šè¿‡ Python ç­‰è¯­è¨€å†™ä¸€ä¸ªæ¶ˆæ¯å¤„ç†å™¨, é€šè¿‡sot-cqp è°ƒç”¨, ä½ æ— éœ€å…³å¿ƒå»å®ç°å¾—åˆ° QQ çš„ç§èŠæˆ–è€…ç¾¤ç»„æ¶ˆæ¯, ä½ åªéœ€è¦å…³å¿ƒå­—ç¬¦ä¸², å›¾åƒ, è¯­è¨€ä¹‹é—´çš„å¤„ç†å³å¯, sot-cqp é€šè¿‡ä½¿ç”¨é…· Q æä¾›çš„æ–‡æ¡£äºŒæ¬¡å¼€å‘è€Œæ¥. 

### 1. å¼€å‘ QA (å‡ ä¸ªè¯¯ä¼šçš„æ¾„æ¸…) 

Q: ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ sot-cqp è€Œä¸ä½¿ç”¨é…· Q æä¾›çš„ API  

A: é…· Q å®˜æ–¹åªæä¾›äº†ä»…æœ‰çš„å‡ ä¸ª api çš„è°ƒç”¨ç‰ˆæœ¬, ç›®å‰åŒ…æ‹¬æ˜“è¯­è¨€å’Œ VC è¿™ä¸¤ä¸ªä¸»è¦ç‰ˆæœ¬. æ˜“è¯­è¨€ç”±äºæµè¡Œç¨‹åº¦å¯¼è‡´å¾ˆå¤šäººéœ€è¦é‡æ–°å»å­¦ä¹ æ˜“è¯­è¨€çš„è¯­æ³•; VC å› ä¸ºå…¶ä¼—æ‰€å‘¨çŸ¥çš„ç½‘ç»œè¯·æ±‚è°ƒç”¨æ‰€è¯Ÿç—…. sot-cqp æ˜¯æˆ‘ç ”ç©¶äº† Python3.7 æ–‡æ¡£ä¸­çš„ Python/C API å®ç°äº† C è°ƒç”¨ Python å‘é€è¯·æ±‚æˆ–è€…åœ¨ Pyhton å†…å‡ºæ¥, åœ¨å°†ç»“æœä»Python ä¸­æ”¾å›åˆ° C ç¨‹åºä¸­. æ›´é‡è¦çš„åŸå› , æˆ‘è®¤ä¸ºåˆ™æ˜¯é…· Q åªæ˜¯æä¾›äº†ä¸€å¥—æ¥å—å’Œå‘é€ QQ æ¶ˆæ¯çš„ SDK è€Œå¹¶æ²¡æœ‰æä¾› DEMO, è€Œåœ¨ QQ ç¾¤ä¸­æ¶ˆæ¯å¾€å¾€æ˜¯é«˜å¹¶å‘çš„, éœ€è¦æœ‰ç›¸å…³å¼€å‘ç»éªŒæ‰èƒ½å°†é—®é¢˜è§£å†³, è€Œå¹¶ä¸å€¼å¾—ä¸»è¦åœ¨æ¶ˆæ¯æˆ–è€…è¯­è¨€å¤„ç†çš„ Python å·¥ä½œè€…æŠ˜è…¾.   
 
### 2. å½“ä¸‹, å‰æ™¯

å½“ä¸‹, å·²ç»è§£å†³çš„é—®é¢˜:   

- ~~APIä»¥åŠä¸»è¦ä»£ç OOPé£æ ¼~~
- ~~å¤šçº¿ç¨‹å¤„ç†ä»¥åŠå…¶ç®¡ç†~~
- ~~å¼‚æ­¥å’Œæ¶ˆæ¯é˜Ÿåˆ—~~
- ~~Pythonçš„å…¨å±€é” GIL~~
- ~~é›†æˆå¼çš„ç»„ä»¶ç®¡ç†~~


å‰æ™¯, è¿˜æœªè§£å†³çš„é—®é¢˜:  

- ç•Œé¢
- â€¦   

å‰æ™¯æœ‰æ— é™å¯èƒ½, å¸Œæœ›ä½ åœ¨ Iusse ä¸­æåŠ.  

### 3. ç‰©æ–™, é£Ÿç”¨è¯´æ˜ä¹¦

**ç‰©æ–™å‡†å¤‡**

- VS2017  
[ä¸‹è½½åœ°å€](https://visualstudio.microsoft.com/zh-hans/thank-you-downloading-visual-studio/?sku=Enterprise&rel=15)

- Python 3.7 + request   
[ä¸‹è½½åœ°å€](https://www.python.org/ftp/python/3.7.2/python-3.7.2.exe)

- é…·Q  
[ä¸‹è½½åœ°å€](http://dlsec.cqp.me/cqa-tuling)

- å¯é€‰
    - å›¾çµ API
    - Python å®ç°å›¾çµè°ƒç”¨çš„ DEMO

**é£Ÿç”¨è¯´æ˜**  

VS2017 

è®¾ç½® `Python` ç¯å¢ƒå¹¶ç¼–è¯‘é¡¹ç›®



æ‚¨å¯ä»¥ç¼–è¯‘ä¸º `cn.son9wx.cubbot.sot-cqp.dll`ï¼Œä¸ `sot-cqp/cn.son9wx.cubbot.sot-cqp.json` ä¸€èµ·æ”¾ç½®åœ¨ é…·Q çš„ app ç›®å½•ä¸‹æµ‹è¯•

`sot-cqp/cn.son9wx.cubbot.sot-cqp.json` - æ ·ä¾‹åº”ç”¨çš„å¯¹åº”ä¿¡æ¯æ–‡ä»¶ï¼ŒåŒ…å«åº”ç”¨çš„åŸºç¡€ä¿¡æ¯ã€äº‹ä»¶åˆ—è¡¨ç­‰ï¼Œè¯·æ”¾ç½®åœ¨ é…·Q çš„ app ç›®å½•ä¸‹ (æ— éœ€ä½¿ç”¨çš„äº‹ä»¶ã€èœå•ã€æƒé™è¯·åœ¨æ­¤åˆ é™¤) 

åœ¨ç¨‹åºä¿®æ”¹å®Œæˆå, å¯ä»¥è‡ªå·±æ‰“åŒ…æˆä»»ä½•å½¢å¼çš„ç¨‹åº. 

å¦‚æœä½ éœ€è¦ä¿®æ”¹ `appid` å¯ä»¥å°†  `cn.son9wx.cubbot.sot-cqp.dll` å’Œ`cn.son9wx.cubbot.sot-cqp.json` å’Œä¿®æ”¹ `appmain.h` ä¸­çš„é…ç½®, åªéœ€è¦ç¡®ä¿ä¸‰ä¸ªåœ°æ–¹æ˜¯ä¸€æ ·çš„å³å¯.  


 
å°†ç”Ÿæˆçš„ dll æ–‡ä»¶å’Œ json ä¸€èµ·æ”¾ç½®åœ¨é…· Q æ–‡ä»¶ç›®å½•ä¸‹, Py æ–‡ä»¶æ”¾å…¥æ›´ç›®å½•ä¸‹å³å¯, å¦‚æœä½ éœ€è¦è‡ªå®šä¹‰ç›®å½•, åœ¨Tulingæ–‡ä»¶ä¸­è¿›è¡Œä¿®æ”¹. å’Œäººå·¥æ™ºéšœä¸€èµ·æ„‰å¿«çš„èŠå¤©å§
 
### 4. èµ°å¿ƒèŠå¤©

é¦–å…ˆ, å…ˆè¦çŸ¥é“Sotçš„åŸºæœ¬å¯¹è±¡, æˆå‘˜, ç¾¤ç»„, æ¶ˆæ¯ç±»é—´å…³ç³»ä¸‹å›¾èƒœè¿‡åƒè¨€ä¸‡è¯­. 

#### - OOP é£æ ¼  
ä¹ æƒ¯äº†OOPå¾ˆå¤šå¹´, æ€»æ„Ÿè§‰cqpæä¾›çš„apiéå¸¸åˆ«æ‰­, ä»£ç å†™å‡ºæ¥æ²¡æœ‰è¯­ä¹‰åŒ–, é€šå¸¸éœ€è¦æ³¨è§£æ‰èƒ½ç†è§£, æ‰€ä»¥é‡‡ç”¨äº†OOPå’Œè¯­ä¹‰åŒ–çš„ä»£ç å¼€å‘å’Œæ–¹æ³•å®šä¹‰, å‡ç¼“å¼€å‘è€…çš„å‹åŠ›.  


ä¸‹é¢å°±æ˜¯åŸºäº `OOP` é£æ ¼çš„äºŒæ¬¡å¼€å‘, ä»£ç ç®€æ´æ˜“æ‡‚, æ²¡æœ‰ç½—å—¦çš„æˆåˆ†. 

```cpp
class Sot
{
public:

	// è·å–åº”ç”¨ç¨‹åºçš„æ‰€åœ¨è·¯å¾„
	static std::string getAppDirectory();

	// è·å–å½“å‰è´¦å·çš„TOKEN
	static int32_t getToken();

	// è·å–å½“å‰è´¦å·çš„Cookies
	static const char *getCookies();

	// å‘é€æ¶ˆæ¯
	static int send(GroupMsg msg);
	static int send(PrivateMsg msg);

	// è°ƒè¯•æ—¥å¿—
	static int log(Log log);

	// ç¦è¨€ç›¸å…³
	// å…¨å‘˜ç¦è¨€
	static void ban(Group group);

	// ç¾¤æˆå‘˜ç¦è¨€
	// ttl ç¦è¨€æ—¶å¸¸
	static void ban(Group group,Member member, int64_t ttl);

	// å…¨å‘˜è§£ç¦
	static void unban(Group group);

	// ç¾¤æˆå‘˜è§£ç¦
	static void unban(Group group, Member member);

};
```


å¾ˆå¤šäººé—®æˆ‘æ€æ ·æ‰ç®— `OOP` é£æ ¼, æœ€æ—©æ¥è§¦åˆ° OOP é£æ ¼å®åœ¨çœ‹ <<Java ç–¯ç‹‚è®²ä¹‰>> çš„æ—¶å€™çœ‹åˆ°çš„, ä¿—è¯è®²å°±æ˜¯ C è¯­è¨€æ˜¯ `ğŸ–.ğŸš¿()` å’Œ `ğŸš¿(ğŸ–)` è¿™æ ·æœ€ç›´æ¥çš„ä½“ç°, ä½†æ˜¯ `OOP` é£æ ¼ä¸ä»£è¡¨ `OOP` æœ¬èº«, ä»–è¿˜æ˜¯éœ€è¦æ»¡è¶³å‡ ä¸ªç‰¹æ€§, å°è£…, å¤šæ€, ç»§æ‰¿. 
 
#### - å¤šçº¿ç¨‹å¤„ç†ä»¥åŠå…¶ç®¡ç†  
è§£è€¦, åˆ©ç”¨ä¸­é—´ä»¶ç®¡ç†å„ä¸ªçº¿ç¨‹, ä¸€ä¸ªçº¿ç¨‹çš„é”™è¯¯ä¸ä¼šå½±å“åˆ°å…¶ä»–çº¿ç¨‹çš„è¿è¡Œ.

ä¸‹é¢è¿™ä¸ª DEMO ç»™äº†å¤§å®¶ä¸€ä¸ªç®€å•çš„ç®¡ç†å®šä¹‰. 

```cpp
ComponentManage * ComponentManage::getInstance()
{
	static ComponentManage* componentManage
		= new ComponentManage();
	return componentManage;
}

GroupMsgThread * ComponentManage::getGroupMsgThreadInstance()
{
	return groupMsgThreadInstance;
}
```

ä½¿ç”¨ `ComponentManage::getInstance()->getGroupMsgThreadInstance()->start();`  è¿›å…¥ç»„ä»¶ç®¡ç†çš„ç»„ä»¶æˆ–è€…çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯æˆ‘ä»¬æ— éœ€å…³å¿ƒ, åªéœ€è¦å¼€å¯å’Œåœæ­¢çº¿ç¨‹å³å¯, è§£è€¦çš„åŒæ—¶è¿˜ç®€åŒ–çš„å¼€å‘çš„å¤æ‚åº¦. 

#### - GIL  
ç—›è‹¦, æ²¡æœ‰æ•™ç¨‹éœ€è¦è‡ªå·±æ‘¸ç´¢, è¿™é‡ŒæŠŠæˆ‘å®ç°çš„æ–¹å¼å±•ç¤ºç»™å¤§å®¶.  

1. åˆå§‹åŒ– å¯ä»¥å…¨å±€åˆå§‹åŒ–ä¸€æ¬¡ä¹Ÿå¯ä»¥è°ƒç”¨å‰æ‰§è¡Œ

```cpp
Py_Initialize();
PyEval_InitThreads();
PyEval_ReleaseThread(PyThreadState_Get());
```

2. çŠ¶æ€é”éšç±»åˆ›å»ºå’Œé”€æ¯

```cpp
GIL::GIL(){	state = PyGILState_Ensure();}
GIL::~GIL(){	PyGILState_Release(state);}
```

3. è°ƒç”¨ Python 

```cpp
GIL gil;

PyObject *modules = nullptr;
PyObject *func = nullptr;
PyObject *args = nullptr;
PyObject *res = nullptr;

modules = PyImport_ImportModule("TuLing"); // ä½ç½®å°±æ˜¯ dll å½“å‰ç›®å½• 

func = PyObject_GetAttrString(modules, "TuLing");

args = PyTuple_New(1);
const char * contentUtf = G2U(content.c_str());

PyTuple_SetItem(args, 0, Py_BuildValue("s", contentUtf));
Sot::log(Log(LOG_INFO, "Py", content));

res = PyObject_CallObject(func, args);
char* ret_str;
if (res != NULL)
    PyArg_Parse(res, "s", &ret_str);

const char * contentGbk = U2G(ret_str);

Py_DECREF(args);
Py_DECREF(func);
Py_DECREF(res);
Py_DECREF(modules);

res = nullptr;
args = nullptr;
func = nullptr;
modules = nullptr;

return std::string(contentGbk);
```

#### - å¼‚æ­¥å’Œæ¶ˆæ¯é˜Ÿåˆ—  
å¼‚æ­¥å¤„ç†æ¶ˆæ¯æ¥å—å’Œæ¶ˆæ¯å¤„ç†ä»¥åŠå‘é€, ä¸éœ€è¦æ‹…å¿ƒå› ä¸ºä¿¡æ¯è¿‡å¤šè€Œå¯¼è‡´ä¸å¯é¢„è®¡çš„é—®é¢˜çš„å‡ºç°. 

```cpp
void GroupMsgThread::push(GroupMsg msg)
{
	if (msgBuffer.size() < 100)
	{
		mutex.lock();
		msgBuffer.push(msg);
		mutex.unlock();
	}
}

void GroupMsgThread::threadMain()
{
	while (!isQuit)
	{
		if (msgBuffer.size() > 0)
		{
			mutex.lock();
			GroupMsg msg = msgBuffer.front();
			msgBuffer.pop();
			mutex.unlock();
			
/*------------------------------TuLing-----------------------------------------*/
			GroupMsg reply(TuLing::getResContent(msg.getContent()), msg.Group::getId());
			Sot::send(reply);
/*------------------------------TuLing-----------------------------------------*/

		}
		else
		{
			Sleep(100);
		}
	}
	return;
}
```

è¿™é‡Œæ³¨æ„äº’æ–¥é”å³å¯. 

#### - ç¼–ç   
é…·Qä¸æ”¯æŒUTF8, è€Œåœ¨ Python3.x æ˜¯ç»Ÿä¸€ unicode ç¼–ç çš„, æ— è®ºåœ¨å“ªè¾¹éƒ½éœ€è¦åšä¸€æ¬¡ç»Ÿä¸€çš„ç¼–ç . 

```cpp
char* U2G(const char* utf8)
{
	int len = MultiByteToWideChar(CP_UTF8, 0, utf8, -1, NULL, 0);
	wchar_t* wstr = new wchar_t[len + 1];
	memset(wstr, 0, len + 1);
	MultiByteToWideChar(CP_UTF8, 0, utf8, -1, wstr, len);
	len = WideCharToMultiByte(CP_ACP, 0, wstr, -1, NULL, 0, NULL, NULL);
	char* str = new char[len + 1];
	memset(str, 0, len + 1);
	WideCharToMultiByte(CP_ACP, 0, wstr, -1, str, len, NULL, NULL);
	if (wstr) delete[] wstr;
	return str;
}

char* G2U(const char* gb2312)
{
	int len = MultiByteToWideChar(CP_ACP, 0, gb2312, -1, NULL, 0);
	wchar_t* wstr = new wchar_t[len + 1];
	memset(wstr, 0, len + 1);
	MultiByteToWideChar(CP_ACP, 0, gb2312, -1, wstr, len);
	len = WideCharToMultiByte(CP_UTF8, 0, wstr, -1, NULL, 0, NULL, NULL);
	char* str = new char[len + 1];
	memset(str, 0, len + 1);
	WideCharToMultiByte(CP_UTF8, 0, wstr, -1, str, len, NULL, NULL);
	if (wstr) delete[] wstr;
	return str;
}
```


### 5. å‚è€ƒèµ„æ–™, è‡´è°¢

- æ„Ÿè°¢Pythonå®˜æ–¹çš„æ–‡æ¡£  
Python 3.7.2 Doc https://docs.python.org/3.6/c-api/index.html

- æ„Ÿè°¢é…·Qå›¢é˜Ÿçš„SDKå’Œæ–‡æ¡£  
SDK (VC) https://github.com/CoolQ/cqsdk-vc/archive/master.zip  
ä¸»ç«™ï¼šhttps://cqp.cc  
æ–‡åº“ï¼šhttps://d.cqp.me 
